---
{% for group, values in secrets.groups.items() %}
- hosts: {{ group }}
  gather_facts: false
  become: yes
  vars:
    users:
  {% for name, values in values.ansible_user.items() %}
      - name: {{ name }}
        pass: {{ getSaltedPassword(values.password) }}
  {% endfor %}
  {% for name, values in values.other_users.items() %}
      - name: {{ name }}
        pass: {{ getSaltedPassword(values.password) }}
  {% endfor %}
  tasks:
{% raw %}
    - name: "new user"
      user:
        name: "{{ item.name }}"
        password: "{{ item.pass }}"
        groups: # Empty by default, here we give it some groups
         - sudo
        state: present
      with_items: "{{ users }}"
    - name: "user ssh key"
      authorized_key:
        user: "{{ item }}"
        key: "{{ lookup('file', '~/.ssh/admin.pub') }}"
      with_items: "{{ users }}"
{% endraw %}
{% endfor %}
